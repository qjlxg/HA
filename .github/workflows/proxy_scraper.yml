name: Auto Update Data # 工作流名称

on:
  push: # 在每次推送到 main 分支时触发
    branches:
      - 'main' # 修正：这里应该是 'main' 分支，而不是脚本文件名或工作流文件路径
  schedule: # 定时任务，每6小时运行一次
    - cron: '0 */6 * * *'
  workflow_dispatch: # 允许手动触发工作流

jobs:
  update-data:
    runs-on: ubuntu-latest # 在 Ubuntu 最新版本上运行

    steps:
      - name: Checkout repository # 步骤1: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取所有历史，这对于后续的 fetch 和 hard reset 是必需的。

      - name: Configure Git # 步骤2: 配置 Git 用户信息
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Set up Python # 步骤3: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # 使用最新的 Python 3 版本，或者指定你的脚本需要的版本

      - name: Install dependencies # 步骤4: 安装 Python 依赖 (如果 proxy_scraper.py 有依赖的话)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # 步骤5: 强制同步到远程主分支 (可选，但在并行执行时有助于避免冲突)
      # ⚠️ 警告: `git reset --hard` 会丢弃所有本地独有的提交，并使本地 HEAD 完全匹配远程 HEAD。
      # 在此工作流中，由于 `stefanzweifel/git-auto-commit-action` 也带有 `pull_strategy`，
      # 此步骤可以作为额外的安全措施，或者在某些复杂情况下用于确保仓库状态干净。
      - name: Fetch and Hard Reset to origin/main
        run: |
          echo "Fetching latest changes from origin..."
          git fetch origin main # 从远程获取最新的 main 分支信息

          echo "Resetting local main branch to origin/main..."
          git reset --hard origin/main
          echo "Local branch is now synced with origin/main."

      - name: Run proxy_scraper.py # 步骤6: 运行你的代理抓取脚本
        run: |
          echo "Running proxy_scraper.py..."
          python proxy_scraper.py
          echo "proxy_scraper.py finished."

      # --- 新增步骤：在自动提交前拉取并变基远程更改 ---
      - name: Pull and Rebase before commit # 步骤7: 拉取并变基远程更改
        run: |
          echo "Pulling latest changes from origin/main with rebase strategy..."
          git pull --rebase origin main
          echo "Local branch is now rebased with origin/main."
          # 注意：如果 rebase 过程中有冲突，这可能会导致工作流失败。
          # 对于自动更新数据的场景，通常不会有冲突，因为数据文件是生成的。
          # 但如果存在其他手动修改或并行工作流，则需要考虑冲突解决策略。

      - name: Auto commit and push # 步骤8: 自动提交并推送更改
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: data/*.txt data/*.csv # 只提交 data/ 目录下的 .txt 和 .csv 文件
          commit_message: 自动更新代理节点和日志 $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          commit_author: qjlxg <12179157+qjlxg@users.noreply.github.com>
          repository: .
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          # push_options: "--force" # 除非你非常清楚自己在做什么，否则不要使用 --force
          # 移除无效的 pull_strategy 参数
          # pull_strategy: "pull_rebase" # 这个参数是无效的，已移除
